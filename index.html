<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Vikhed Search">
    <title>Equity Khoj | Insider Search</title>
    <link rel="stylesheet" href="style.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8913157627408931" crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PTLQQ13JE"></script>
    <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'G-5PTLQQ13JE');
    </script>
</head>

<body>
    <div id="search-banner" style="text-align: center;">
        <!-- <img style="border-radius: 20px;" src="assets/equity-khoj.jpg"> -->
        <h1>Insider Trades filed at NSE</h1>
        <br>
        <!-- <h4 style="font-family: 'Google Sans';">Search Insider trading information filed with NSE</h4> --></div>
    <!-- <div class="hero">
            <div class="searchBox">
            <input type="search" placeholder="Enter ticker symbol" id="query">
            <span style="font-size: 1.5em; padding-left: 2%; cursor: pointer;" onclick="submitDetails()">üîç</span>
        </div>
    </div> -->
    <div class="filters">
        <input id="symbol" placeholder="Filter by symbol">
        <label for="tdpTransactionType"></label>
        <select name="tdpTransactionType" id="tdpTransactionType">
            <option value="" selected>Filter by transaction type</option>
            <option value="Buy">Buy</option>
            <option value="Sell">Sell</option>
        </select>
        <input style="width: auto;" type="submit" value="Search" onclick="search()">
        <input style="width: auto;" type="submit" value="Export to excel" onclick="convertTableToExcel('insider_table')"> 
    </div>
    <table id="insider_table">
        <tr>
            <th>Symbol</th>
            <th>Company</th>
            <th>Acquirer Name</th>
            <th>Date</th>
            <th>Transaction Type</th>
            <th>Security Type</th>
            <th>No. of shares</th>
            <th>Amount</th>
            <th>Person Category</th>
        </tr>
    </table>
    <script type="text/javascript" src="https://vikhed.in/vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script type="text/javascript">
    var API_BASE_URL = "https://vikhed.in/api/"
    // var API_BASE_URL = "http://127.0.0.1:2100/api/"

    function search() {
        $.ajax({
            type: "POST",
            url: API_BASE_URL + "insider_trades/latest/search",
            data: JSON.stringify({
                filters: {
                    symbol: $('#symbol').val(),
                    tdpTransactionType: $('#tdpTransactionType').val()
                }
            }),
            contentType: "application/json",
            encode: true,
        }).done(function(data) {
            if(data.status == 200) {
                $('#insider_table').html("<tr> <th>Symbol</th> <th>Company</th> <th>Acquirer Name</th> <th>Date</th> <th>Transaction Type</th> <th>Security Type</th> <th>No. of shares</th> <th>Amount</th> <th>Person Category</th> </tr>");
                for(var i = 0; i < data.table_data.length; i++) {
                    $('#insider_table').append(`<tr class='${data.table_data[i].tdpTransactionType.toLowerCase()}'> <td>${data.table_data[i].symbol}</td> <td>${data.table_data[i].company}</td> <td>${data.table_data[i].acqName}</td> <td>${data.table_data[i].date}</td> <td>${data.table_data[i].tdpTransactionType}</td> <td>${data.table_data[i].secType}</td> <td>${data.table_data[i].secAcq}</td> <td>${data.table_data[i].secVal}</td> <td>${data.table_data[i].personCategory}</td> </tr>`)
                }
            }
        });
    }

    function populateLatest() {
        $.ajax({
            type: "POST",
            url: API_BASE_URL + "insider_trades/latest",
            data: JSON.stringify({
                symbol: $('#query').val()
            }),
            contentType: "application/json",
            encode: true,
        }).done(function(data) {
            if(data.status == 200) {
                for(var i = 0; i < data.table_data.length; i++) {
                    $('#insider_table').append(`<tr class='${data.table_data[i].tdpTransactionType.toLowerCase()}'> <td>${data.table_data[i].symbol}</td> <td>${data.table_data[i].company}</td> <td>${data.table_data[i].acqName}</td> <td>${data.table_data[i].date}</td> <td>${data.table_data[i].tdpTransactionType}</td> <td>${data.table_data[i].secType}</td> <td>${data.table_data[i].secAcq}</td> <td>${data.table_data[i].secVal}</td> <td>${data.table_data[i].personCategory}</td> </tr>`)
                }
            }
        });
    }
    populateLatest();

    function convertTableToExcel(tableId, fileName = "Insider Data") {
        if($('#symbol').val() != "") {
            fileName = fileName + "_" + $('#symbol').val()
        }
        if($('#tdpTransactionType').val() != null) {
            fileName = fileName + "_" + $('#tdpTransactionType').val()
        }
        fileName = fileName + ".xlsx"
        // Check if the 'xlsx' library is available
        if(typeof XLSX === 'undefined') {
            console.error("The 'xlsx' library is required to convert the table to Excel.");
            return;
        }
        const table = document.getElementById(tableId);
        if(!table) {
            console.error("Table with the provided ID does not exist.");
            return;
        }
        const worksheet = XLSX.utils.table_to_sheet(table);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
        // Generate the XLSX file
        const wbout = XLSX.write(workbook, {
            bookType: 'xlsx',
            type: 'binary'
        });
        // Download the XLSX file
        const blob = new Blob([s2ab(wbout)], {
            type: 'application/octet-stream'
        });
        if(navigator.msSaveBlob) {
            navigator.msSaveBlob(blob, fileName); // For IE 10+
        } else {
            const link = document.createElement('a');
            if(link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    }
    // Utility function to convert string to ArrayBuffer
    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for(let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xff;
        return buf;
    }
    </script>
</body>

</html>